#!/bin/bash
set -e

# === Paths ===
metadataJson="package/metadata.json"
metadataDesktop="package/metadata.desktop"

# === Extract plugin info ===
if [[ -f "$metadataJson" ]]; then
    packageNamespace=$(jq -r '.KPlugin.Id // empty' "$metadataJson")
    packageServiceType=$(jq -r '.KPackageStructure // (.KPlugin.ServiceTypes[0] // empty)' "$metadataJson")
    if [[ -z "$packageServiceType" ]]; then
        echo "[warning] metadata.json is missing KPackageStructure"
    fi
elif [[ -f "$metadataDesktop" ]]; then
    packageNamespace=$(grep -E '^X-KDE-PluginInfo-Name=' "$metadataDesktop" | cut -d= -f2)
    packageServiceType=$(grep -E '^X-KDE-ServiceTypes=' "$metadataDesktop" | cut -d= -f2)
else
    echo "[error] No metadata found"
    exit 1
fi

if [[ -z "$packageNamespace" || -z "$packageServiceType" ]]; then
    echo "[error] Could not extract plugin info"
    exit 1
fi

echo "Namespace: $packageNamespace"
echo "Type: $packageServiceType"

# === Detect kpackagetool ===
if command -v kpackagetool6 &> /dev/null; then
    kpackagetool="kpackagetool6"
elif command -v kpackagetool5 &> /dev/null; then
    kpackagetool="kpackagetool5"
else
    echo "[error] kpackagetool not found"
    exit 1
fi

# === Uninstall ===
"$kpackagetool" --type="$packageServiceType" --remove="$packageNamespace"
