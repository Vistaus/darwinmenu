#!/bin/bash
set -e

# === Detect metadata ===
metadataJson="package/metadata.json"
metadataDesktop="package/metadata.desktop"

if [[ -f "$metadataJson" ]]; then
    packageNamespace=$(jq -r '.KPlugin.Id // empty' "$metadataJson")
    packageServiceType=$(jq -r '.KPackageStructure // (.KPlugin.ServiceTypes[0] // empty)' "$metadataJson")
    if [[ -z "$packageServiceType" ]]; then
        echo "[warning] metadata.json is missing KPackageStructure"
    fi
elif [[ -f "$metadataDesktop" ]]; then
    packageNamespace=$(grep -E '^X-KDE-PluginInfo-Name=' "$metadataDesktop" | cut -d= -f2)
    packageServiceType=$(grep -E '^X-KDE-ServiceTypes=' "$metadataDesktop" | cut -d= -f2)
else
    echo "[error] No metadata found"
    exit 1
fi

if [[ -z "$packageNamespace" || -z "$packageServiceType" ]]; then
    echo "[error] Could not extract plugin info"
    exit 1
fi

echo "Namespace: $packageNamespace"
echo "Type: $packageServiceType"

# === Detect tools ===
if command -v kpackagetool6 &> /dev/null; then
    kpackagetool="kpackagetool6"
elif command -v kpackagetool5 &> /dev/null; then
    kpackagetool="kpackagetool5"
else
    echo "[error] kpackagetool not found"
    exit 1
fi

if command -v kstart &> /dev/null; then
    kstart="kstart"
elif command -v kstart5 &> /dev/null; then
    kstart="kstart5"
else
    echo "[error] kstart not found"
    exit 1
fi

# === Parse args ===
restartPlasmashell=false
for arg in "$@"; do
    case "$arg" in
        -r|--restart) restartPlasmashell=true ;;
    esac
done

# === Install or upgrade ===
if "$kpackagetool" --type="$packageServiceType" --show="$packageNamespace" &> /dev/null; then
    echo "[install] Upgrading existing package..."
    "$kpackagetool" --type="$packageServiceType" --upgrade package
else
    echo "[install] Installing new package..."
    "$kpackagetool" --type="$packageServiceType" --install package
fi

# === Restart plasmashell if requested ===
if $restartPlasmashell; then
    killall plasmashell || true
    "$kstart" plasmashell &
fi
